<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-test/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-test";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>19 | Java字节码（基础篇） - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/深入拆解java虚拟机/03.模块二高效编译/08" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>java开发<ul><li><a href="/blog-test/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-test/java并发编程实战">java并发编程实战</a></li><li><a href="/blog-test/java性能调优实战">java性能调优实战</a></li><li><a href="/blog-test/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-test/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-test/深入剖析java新特性">深入剖析java新特性</a></li><li><a aria-current="page" class="active" href="/blog-test/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></span><span>架构师<ul><li><a href="/blog-test/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a href="/blog-test/从0开始学微服务">从0开始学微服务</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>java开发<ul><li><a href="/blog-test/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-test/java并发编程实战">java并发编程实战</a></li><li><a href="/blog-test/java性能调优实战">java性能调优实战</a></li><li><a href="/blog-test/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-test/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-test/深入剖析java新特性">深入剖析java新特性</a></li><li><a aria-current="page" class="active" href="/blog-test/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></li><li>架构师<ul><li><a href="/blog-test/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a href="/blog-test/从0开始学微服务">从0开始学微服务</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-test/深入拆解java虚拟机">深入拆解java虚拟机</a></li><li><a href="/blog-test/深入拆解java虚拟机/01.开篇词">01.开篇词</a><ul><li><a href="/blog-test/深入拆解java虚拟机/01.开篇词/01"><span>开篇词 | 为什么我们要学习Java虚拟机？</span></a></li></ul></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理">02.模块一Java虚拟机基本原理</a><ul><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/01"><span>01 | Java代码是怎么运行的？</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/02"><span>02 | Java的基本类型</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/03"><span>03 | Java虚拟机是如何加载Java类的?</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/04"><span>04 | JVM是如何执行方法调用的？（上）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/05"><span>05 | JVM是如何执行方法调用的？（下）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/06"><span>06 | JVM是如何处理异常的？</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/07"><span>07 | JVM是如何实现反射的？</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/08"><span>08 | JVM是怎么实现invokedynamic的？（上）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/09"><span>09 | JVM是怎么实现invokedynamic的？（下）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/10"><span>10 | Java对象的内存布局</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/11"><span>11 | 垃圾回收（上）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/02.模块一java虚拟机基本原理/12"><span>12 | 垃圾回收（下）</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译">03.模块二高效编译</a><ul><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/01"><span>【工具篇】 常用工具介绍</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/02"><span>13 | Java内存模型</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/03"><span>14 | Java虚拟机是怎么实现synchronized的？</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/04"><span>15 | Java语法糖与Java编译器</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/05"><span>16 | 即时编译（上）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/06"><span>17 | 即时编译（下）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/07"><span>18 | 即时编译器的中间表达形式</span></a></li><li><a aria-current="page" class="active" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08"><span>19 |  Java字节码（基础篇）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/09"><span>20 | 方法内联（上）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/10"><span>21 | 方法内联（下）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/11"><span>22 | HotSpot虚拟机的intrinsic</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/12"><span>23 | 逃逸分析</span></a></li></ul></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化">04.模块三代码优化</a><ul><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/01"><span>24 | 字段访问相关优化</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/02"><span>25 | 循环优化</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/03"><span>26 | 向量化</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/04"><span>27 | 注解处理器</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/05"><span>28 | 基准测试框架JMH（上）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/06"><span>29 | 基准测试框架JMH（下）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/07"><span>30 | Java虚拟机的监控及诊断工具（命令行篇）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/08"><span>31 | Java虚拟机的监控及诊断工具（GUI篇）</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/09"><span>32 | JNI的运行机制</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/04.模块三代码优化/10"><span>33 | Java Agent与字节码注入</span></a></li></ul></li><li><a href="/blog-test/深入拆解java虚拟机/05.模块四黑科技">05.模块四黑科技</a><ul><li><a href="/blog-test/深入拆解java虚拟机/05.模块四黑科技/01"><span>34 | Graal：用Java编译Java</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/05.模块四黑科技/02"><span>35 | Truffle：语言实现框架</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/05.模块四黑科技/03"><span>36 | SubstrateVM：AOT编译框架</span></a></li></ul></li><li><a href="/blog-test/深入拆解java虚拟机/06.尾声">06.尾声</a><ul><li><a href="/blog-test/深入拆解java虚拟机/06.尾声/01"><span>尾声 | 道阻且长，努力加餐</span></a></li><li><a href="/blog-test/深入拆解java虚拟机/06.尾声/02"><span>结课测试 | 这些Java虚拟机的知识你都掌握了吗？</span></a></li></ul></li><li><a href="/blog-test/深入拆解java虚拟机/summary">深入拆解java虚拟机</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="操作数栈" data-depth="2"><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#操作数栈"><span>操作数栈</span></a></li><li title="局部变量区" data-depth="2"><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#局部变量区"><span>局部变量区</span></a></li><li title="综合示例" data-depth="2"><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#综合示例"><span>综合示例</span></a></li><li title="Java字节码简介" data-depth="2"><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#java字节码简介"><span>Java字节码简介</span></a></li><li title="总结与实践" data-depth="2"><a href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#总结与实践"><span>总结与实践</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="19---java字节码基础篇"><a aria-hidden="true" tabindex="-1" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#19---java字节码基础篇"><span class="icon icon-link"></span></a>19 |  Java字节码（基础篇）</h1><p>在前面的篇章中，有不少同学反馈对Java字节码并不是特别熟悉。那么今天我便来系统性地介绍一遍Java字节码。</p><h2 id="操作数栈"><a aria-hidden="true" tabindex="-1" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#操作数栈"><span class="icon icon-link"></span></a>操作数栈</h2><p>我们知道，Java字节码是Java虚拟机所使用的指令集。因此，它与Java虚拟机基于栈的计算模型是密不可分的。</p><p>在解释执行过程中，每当为Java方法分配栈桢时，Java虚拟机往往需要开辟一块额外的空间作为操作数栈，来存放计算的操作数以及返回结果。</p><p>具体来说便是：执行每一条指令之前，Java虚拟机要求该指令的操作数已被压入操作数栈中。在执行指令时，Java虚拟机会将该指令所需的操作数弹出，并且将指令的结果重新压入栈中。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage132113720f6eb83d096ec600309648330821.e9b82c40.png" alt=""/></p><p>以加法指令iadd为例。假设在执行该指令前，栈顶的两个元素分别为int值1和int值2，那么iadd指令将弹出这两个int，并将求得的和int值3压入栈中。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>由于iadd指令只消耗栈顶的两个元素，因此，对于离栈顶距离为2的元素，即图中的问号，iadd指令并不关心它是否存在，更加不会对其进行修改。</p><p>Java字节码中有好几条指令是直接作用在操作数栈上的。最为常见的便是dup： 复制栈顶元素，以及pop：舍弃栈顶元素。</p><p>dup指令常用于复制new指令所生成的未经初始化的引用。例如在下面这段代码的foo方法中，当执行new指令时，Java虚拟机将指向一块已分配的、未初始化的内存的引用压入操作数栈中。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public void foo() {</span></div><div class="token-line"><span class="token plain">        Object o = new Object();</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      // 对应的字节码如下：</span></div><div class="token-line"><span class="token plain">      public void foo();</span></div><div class="token-line"><span class="token plain">        0  new java.lang.Object [3]</span></div><div class="token-line"><span class="token plain">        3  dup</span></div><div class="token-line"><span class="token plain">        4  invokespecial java.lang.Object() [8]</span></div><div class="token-line"><span class="token plain">        7  astore_1 [o]</span></div><div class="token-line"><span class="token plain">        8  return</span></div></pre></div><p>接下来，我们需要以这个引用为调用者，调用其构造器，也就是上面字节码中的invokespecial指令。要注意，该指令将消耗操作数栈上的元素，作为它的调用者以及参数（不过Object的构造器不需要参数）。</p><p>因此，我们需要利用dup指令复制一份new指令的结果，并用来调用构造器。当调用返回之后，操作数栈上仍有原本由new指令生成的引用，可用于接下来的操作（即偏移量为7的字节码，下面会介绍到）。</p><p>pop指令则常用于舍弃调用指令的返回结果。例如在下面这段代码的foo方法中，我将调用静态方法bar，但是却不用其返回值。</p><p>由于对应的invokestatic指令仍旧会将返回值压入foo方法的操作数栈中，因此Java虚拟机需要额外执行pop指令，将返回值舍弃。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static boolean bar() {</span></div><div class="token-line"><span class="token plain">        return false;</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">      public void foo() {</span></div><div class="token-line"><span class="token plain">        bar();</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      // foo方法对应的字节码如下：</span></div><div class="token-line"><span class="token plain">      public void foo();</span></div><div class="token-line"><span class="token plain">        0  invokestatic FooTest.bar() : boolean [24]</span></div><div class="token-line"><span class="token plain">        3  pop</span></div><div class="token-line"><span class="token plain">        4  return</span></div></pre></div><p>需要注意的是，上述两条指令只能处理非long或者非double类型的值，这是因为long类型或者double类型的值，需要占据两个栈单元。当遇到这些值时，我们需要同时复制栈顶两个单元的dup2指令，以及弹出栈顶两个单元的pop2指令。</p><p>除此之外，不算常见但也是直接作用于操作数栈的还有swap指令，它将交换栈顶两个元素的值。</p><p>在Java字节码中，有一部分指令可以直接将常量加载到操作数栈上。以int类型为例，Java虚拟机既可以通过iconst指令加载-1至5之间的int值，也可以通过bipush、sipush加载一个字节、两个字节所能代表的int值。</p><p>Java虚拟机还可以通过ldc加载常量池中的常量值，例如ldc #18将加载常量池中的第18项。</p><p>这些常量包括int类型、long类型、float类型、double类型、String类型以及Class类型的常量。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage0c990cd25310027d1fbcca1d6f3301186199.7f1766e4.jpg" alt=""/></p><p><strong>常数加载指令表</strong></p><p>正常情况下，操作数栈的压入弹出都是一条条指令完成的。唯一的例外情况是在抛异常时，Java虚拟机会清除操作数栈上的所有内容，而后将异常实例压入操作数栈上。</p><h2 id="局部变量区"><a aria-hidden="true" tabindex="-1" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#局部变量区"><span class="icon icon-link"></span></a>局部变量区</h2><p>Java方法栈桢的另外一个重要组成部分则是局部变量区，字节码程序可以将计算的结果缓存在局部变量区之中。</p><p>实际上，Java虚拟机将局部变量区当成一个数组，依次存放this指针（仅非静态方法），所传入的参数，以及字节码中的局部变量。</p><p>和操作数栈一样，long类型以及double类型的值将占据两个单元，其余类型仅占据一个单元。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public void foo(long l, float f) {</span></div><div class="token-line"><span class="token plain">      {</span></div><div class="token-line"><span class="token plain">        int i = 0;</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      {</span></div><div class="token-line"><span class="token plain">        String s = &quot;Hello, World&quot;;</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>以上面这段代码中的foo方法为例，由于它是一个实例方法，因此局部变量数组的第0个单元存放着this指针。</p><p>第一个参数为long类型，于是数组的1、2两个单元存放着所传入的long类型参数的值。第二个参数则是float类型，于是数组的第3个单元存放着所传入的float类型参数的值。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABOAAAACOCAMAAACv1Id7AAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAJYUExURf///9bV1YHUU0ah+JHZaZbbb5Xbb4HUVKbhhrXmmpLaaqXghI3YY6rii4PVVpzdeKniirPlmLDklJfbcYfWW/n99+b23dvzzqfhh6riitjyyp7eeuT22/D66vn99rHklL/pp8nstYzYYrTmmeH11/v++onXXu756JTabZHaafr9+NPww8Dpqe355s3uusvtuNfxyMTrrqPfgY7ZZavijJ7ee9zzz8XrsIrXYKLfgILVVfP77u/66ef33qfhhu755/7//pDZaJTbbaTgg6nhiZfccYXWWYTVWJjcc/3+/N300YrXX6PggqvjjaHffpLaa4XVWL7pp9/01MLqq7zopO/56f///uz45azjjp/efMLqrNPwwvD6673ppbrnoZbbcLnnoK3jj47YZbnnn+X23ILUVNfyyer44uL12I/ZZpDZZ+r44/z++83uu7bmm/f89LLllu3559zz0PL77Zzdd8rtt8DqqfH669LwwtbxyNXxxtryzLPll4TVV/L67dDvv+X225rcdeP12dLvwdbxx/j89fX78dnyy4bWWvj99uf33+L114zYY8jss6TggsXrr8nttfz++ojWXK/kkrfnnc7uvMPqrdTwxMzuutHvwJncc5/ee8fss/b88qjhiNXxxY3YZMztuYfWXOD01fP7777ppvH67P7+/ej337HlldnyzLroocvtt/T7763jkMbrsej34N/00/X88rjnnq7kkcTrr5rddZPaa5Xbbt700un44crttuv446Hff/T78NDvvuz55bDkk4vYYeH11rfmnbvoo6DefabghT1PoIQAAAABYktHRACIBR1IAAAAB3RJTUUH5wkbARknclVFMQAAAAFvck5UAc+id5oAAAqySURBVHja7Z37fxTVGYfTKTEJSJTaIhexGkURFG2xiitCWqk1losEjRTvUqSxKXhBLVRUVCo2aC1gRVTEqqVatFovrdqL0tu/1Tmzs7sTMmbPmXPO7J7X5/lpzp7Z+fq+83kfEveSjg4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgPbmKwAA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" alt=""/></p><p>在方法体里的两个代码块中，我分别定义了两个局部变量i和s。由于这两个局部变量的生命周期没有重合之处，因此，Java编译器可以将它们编排至同一单元中。也就是说，局部变量数组的第4个单元将为i或者s。</p><p>存储在局部变量区的值，通常需要加载至操作数栈中，方能进行计算，得到计算结果后再存储至局部变量数组中。这些加载、存储指令是区分类型的。例如，int类型的加载指令为iload，存储指令为istore。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage607360615f212fe3c40e152eb1829d5c0073.73e538f9.jpg" alt=""/></p><p><strong>局部变量区访问指令表</strong></p><p>局部变量数组的加载、存储指令都需要指明所加载单元的下标。举例来说，aload 0指的是加载第0个单元所存储的引用，在前面示例中的foo方法里指的便是加载this指针。</p><p>在我印象中，Java字节码中唯一能够直接作用于局部变量区的指令是iinc M N（M为非负整数，N为整数）。该指令指的是将局部变量数组的第M个单元中的int值增加N，常用于for循环中自增量的更新。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public void foo() {</span></div><div class="token-line"><span class="token plain">        for (int i = 100; i&gt;=0; i--) {}</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      // 对应的字节码如下：</span></div><div class="token-line"><span class="token plain">      public void foo();</span></div><div class="token-line"><span class="token plain">         0  bipush 100</span></div><div class="token-line"><span class="token plain">         2  istore_1 [i]</span></div><div class="token-line"><span class="token plain">         3  goto 9</span></div><div class="token-line"><span class="token plain">         6  iinc 1 -1 [i] // i--</span></div><div class="token-line"><span class="token plain">         9  iload_1 [i]</span></div><div class="token-line"><span class="token plain">        10  ifge 6</span></div><div class="token-line"><span class="token plain">        13  return</span></div></pre></div><h2 id="综合示例"><a aria-hidden="true" tabindex="-1" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#综合示例"><span class="icon icon-link"></span></a>综合示例</h2><p>下面我们来看一个综合的例子：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static int bar(int i) {</span></div><div class="token-line"><span class="token plain">      return ((i + 1) - 2) * 3 / 4;</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    // 对应的字节码如下：</span></div><div class="token-line"><span class="token plain">    Code:</span></div><div class="token-line"><span class="token plain">      stack=2, locals=1, args_size=1</span></div><div class="token-line"><span class="token plain">         0: iload_0</span></div><div class="token-line"><span class="token plain">         1: iconst_1</span></div><div class="token-line"><span class="token plain">         2: iadd</span></div><div class="token-line"><span class="token plain">         3: iconst_2</span></div><div class="token-line"><span class="token plain">         4: isub</span></div><div class="token-line"><span class="token plain">         5: iconst_3</span></div><div class="token-line"><span class="token plain">         6: imul</span></div><div class="token-line"><span class="token plain">         7: iconst_4</span></div><div class="token-line"><span class="token plain">         8: idiv</span></div><div class="token-line"><span class="token plain">         9: ireturn</span></div></pre></div><p>这里我定义了一个bar方法。它将接收一个int类型的参数，进行一系列计算之后再返回。</p><p>对应的字节码中的stack=2, locals=1代表该方法需要的操作数栈空间为2，局部变量数组空间为1。当调用bar(5)时，每条指令执行前后局部变量数组空间以及操作数栈的分布如下：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagec532c57cb9c2222f0f79459bf4c58e1a4c32.e576ac3f.png" alt=""/></p><h2 id="java字节码简介"><a aria-hidden="true" tabindex="-1" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#java字节码简介"><span class="icon icon-link"></span></a>Java字节码简介</h2><p>前面我已经介绍了加载常量指令、操作数栈专用指令以及局部变量区访问指令。下面我们来看看其他的类别。</p><p>Java相关指令，包括各类具备高层语义的字节码，即new（后跟目标类，生成该类的未初始化的对象），instanceof（后跟目标类，判断栈顶元素是否为目标类/接口的实例。是则压入1，否则压入0），checkcast（后跟目标类，判断栈顶元素是否为目标类/接口的实例。如果不是便抛出异常），athrow（将栈顶异常抛出），以及monitorenter（为栈顶对象加锁）和monitorexit（为栈顶对象解锁）。</p><p>此外，该类型的指令还包括字段访问指令，即静态字段访问指令getstatic、putstatic，和实例字段访问指令getfield、putfield。这四条指令均附带用以定位目标字段的信息，但所消耗的操作数栈元素皆不同。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>以putfield为例，在上图中，它会把值v存储至对象obj的目标字段之中。</p><p>方法调用指令，包括invokestatic，invokespecial，invokevirtual，invokeinterface以及invokedynamic。这几条字节码我们已经反反复复提及了，就不再具体介绍各自的含义了。</p><p>除invokedynamic外，其他的方法调用指令所消耗的操作数栈元素是根据调用类型以及目标方法描述符来确定的。在进行方法调用之前，程序需要依次压入调用者（invokestatic不需要），以及各个参数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public int neg(int i) {</span></div><div class="token-line"><span class="token plain">        return -i;</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">      public int foo(int i) {</span></div><div class="token-line"><span class="token plain">        return neg(neg(i));</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      // foo方法对应的字节码如下：foo方法对应的字节码如下：</span></div><div class="token-line"><span class="token plain">      public int foo(int i);</span></div><div class="token-line"><span class="token plain">        0  aload_0 [this]</span></div><div class="token-line"><span class="token plain">        1  aload_0 [this]</span></div><div class="token-line"><span class="token plain">        2  iload_1 [i]</span></div><div class="token-line"><span class="token plain">        3  invokevirtual FooTest.neg(int) : int [25]</span></div><div class="token-line"><span class="token plain">        6  invokevirtual FooTest.neg(int) : int [25]</span></div><div class="token-line"><span class="token plain">        9  ireturn</span></div></pre></div><p>以上面这段代码为例，当调用foo(2)时，每条指令执行前后局部变量数组空间以及操作数栈的分布如下所示：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage4795476fa1bcb6b36b5b651c2a4101073295.3300c852.png" alt=""/></p><p>数组相关指令，包括新建基本类型数组的newarray，新建引用类型数组的anewarray，生成多维数组的multianewarray，以及求数组长度的arraylength。另外，它还包括数组的加载指令以及存储指令。这些指令是区分类型的。例如，int数组的加载指令为iaload，存储指令为iastore。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage8ef18ee0ed86242a63b566d55297a88da9f1.e3a7bc6f.jpg" alt=""/></p><p><strong>数组访问指令表</strong></p><p>控制流指令，包括无条件跳转goto，条件跳转指令，tableswitch和lookupswtich（前者针对密集的cases，后者针对稀疏的cases），返回指令，以及被废弃的jsr，ret指令。其中返回指令是区分类型的。例如，返回int值的指令为ireturn。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimagef5f0f5195b5425a9547af9ce8371aef5c4f0.97be3f30.jpg" alt=""/></p><p><strong>返回指令表</strong></p><p>除返回指令外，其他的控制流指令均附带一个或者多个字节码偏移量，代表需要跳转到的位置。例如下面的abs方法中偏移量为1的条件跳转指令，当栈顶元素小于0时，跳转至偏移量为6的字节码。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public int abs(int i) {</span></div><div class="token-line"><span class="token plain">        if (i &gt;= 0) {</span></div><div class="token-line"><span class="token plain">          return i;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        return -i;</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      // 对应的字节码如下所示：</span></div><div class="token-line"><span class="token plain">      public int abs(int i);</span></div><div class="token-line"><span class="token plain">        0  iload_1 [i]</span></div><div class="token-line"><span class="token plain">        1  iflt 6</span></div><div class="token-line"><span class="token plain">        4  iload_1 [i]</span></div><div class="token-line"><span class="token plain">        5  ireturn</span></div><div class="token-line"><span class="token plain">        6  iload_1 [i]</span></div><div class="token-line"><span class="token plain">        7  ineg</span></div><div class="token-line"><span class="token plain">        8  ireturn</span></div></pre></div><p>剩余的Java字节码几乎都和计算相关，这里就不再详细阐述了。</p><h2 id="总结与实践"><a aria-hidden="true" tabindex="-1" href="/blog-test/深入拆解java虚拟机/03.模块二高效编译/08#总结与实践"><span class="icon icon-link"></span></a>总结与实践</h2><p>今天我简单介绍了各种类型的Java字节码。</p><p>Java方法的栈桢分为操作数栈和局部变量区。通常来说，程序需要将变量从局部变量区加载至操作数栈中，进行一番运算之后再存储回局部变量区中。</p><p>Java字节码可以划分为很多种类型，如加载常量指令，操作数栈专用指令，局部变量区访问指令，Java相关指令，方法调用指令，数组相关指令，控制流指令，以及计算相关指令。</p><p>今天的实践环节，你可以尝试自己分析一段较为复杂的字节码，在草稿上画出局部变量数组以及操作数栈分布图。当碰到不熟悉的指令时，你可以查阅<a target="_blank" rel="noopener noreferrer" href="https://docs.oracle.com/javase/specs/jvms/se10/html/jvms-6.html#jvms-6.5">Java虚拟机规范第6.5小节<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，或者<a target="_blank" rel="noopener noreferrer" href="https://cs.au.dk/~mis/dOvs/jvmspec/ref-Java.html">此链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/深入拆解java虚拟机/03.模块二高效编译/08.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 09:43:57</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-test/umi.3ded5539.js"></script>
  </body>
</html>
