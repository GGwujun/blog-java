<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-test/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-test";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>14 | 多线程之锁优化（下）：使用乐观锁优化并行操作 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/java性能调优实战/04.模块三·多线程性能调优/03" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>java开发<ul><li><a href="/blog-test/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-test/java并发编程实战">java并发编程实战</a></li><li><a aria-current="page" class="active" href="/blog-test/java性能调优实战">java性能调优实战</a></li><li><a href="/blog-test/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-test/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-test/深入剖析java新特性">深入剖析java新特性</a></li><li><a href="/blog-test/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></span><span>架构师<ul><li><a href="/blog-test/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a href="/blog-test/从0开始学微服务">从0开始学微服务</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>java开发<ul><li><a href="/blog-test/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-test/java并发编程实战">java并发编程实战</a></li><li><a aria-current="page" class="active" href="/blog-test/java性能调优实战">java性能调优实战</a></li><li><a href="/blog-test/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-test/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-test/深入剖析java新特性">深入剖析java新特性</a></li><li><a href="/blog-test/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></li><li>架构师<ul><li><a href="/blog-test/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a href="/blog-test/从0开始学微服务">从0开始学微服务</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-test/java性能调优实战">java性能调优实战</a></li><li><a href="/blog-test/java性能调优实战/01.开篇词">01.开篇词</a><ul><li><a href="/blog-test/java性能调优实战/01.开篇词/01"><span>开篇词 | 怎样才能做好性能调优？</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/02.模块一·概述">02.模块一·概述</a><ul><li><a href="/blog-test/java性能调优实战/02.模块一·概述/01"><span>01 | 如何制定性能调优标准？</span></a></li><li><a href="/blog-test/java性能调优实战/02.模块一·概述/02"><span>02 | 如何制定性能调优策略？</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优">03.模块二·Java编程性能调优</a><ul><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/01"><span>03 | 字符串性能优化不容小觑，百M内存轻松存储几十G数据</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/02"><span>04 | 慎重使用正则表达式</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/03"><span>05 | ArrayList还是LinkedList？使用不当性能差千倍</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/04"><span>加餐 | 推荐几款常用的性能测试工具</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/05"><span>06 | Stream如何提高遍历集合效率？</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/06"><span>07 | 深入浅出HashMap的设计与优化</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/07"><span>08 | 网络通信优化之I/O模型：如何解决高并发下I/O瓶颈？</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/08"><span>09 | 网络通信优化之序列化：避免使用Java序列化</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/09"><span>10 | 网络通信优化之通信协议：如何优化RPC网络通信？</span></a></li><li><a href="/blog-test/java性能调优实战/03.模块二·java编程性能调优/10"><span>11 | 答疑课堂：深入了解NIO的优化实现原理</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优">04.模块三·多线程性能调优</a><ul><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/01"><span>12 | 多线程之锁优化（上）：深入了解Synchronized同步锁的优化方法</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/02"><span>13 | 多线程之锁优化（中）：深入了解Lock同步锁的优化方法</span></a></li><li><a aria-current="page" class="active" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03"><span>14 | 多线程之锁优化（下）：使用乐观锁优化并行操作</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/04"><span>15 | 多线程调优（上）：哪些操作导致了上下文切换？</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/05"><span>16 | 多线程调优（下）：如何优化多线程上下文切换？</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/06"><span>17 | 并发容器的使用：识别不同场景下最优容器</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/07"><span>18 | 如何设置线程池大小？</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/08"><span>19 | 如何用协程来优化多线程业务？</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/09"><span>20 | 答疑课堂：模块三热点问题解答</span></a></li><li><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/10"><span>加餐 | 什么是数据的强、弱一致性？</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/05.模块四·jvm性能监测及调优">05.模块四·JVM性能监测及调优</a><ul><li><a href="/blog-test/java性能调优实战/05.模块四·jvm性能监测及调优/01"><span>21 | 磨刀不误砍柴工：欲知JVM调优先了解JVM内存模型</span></a></li><li><a href="/blog-test/java性能调优实战/05.模块四·jvm性能监测及调优/02"><span>22 | 深入JVM即时编译器JIT，优化Java编译</span></a></li><li><a href="/blog-test/java性能调优实战/05.模块四·jvm性能监测及调优/03"><span>23 | 如何优化垃圾回收机制？</span></a></li><li><a href="/blog-test/java性能调优实战/05.模块四·jvm性能监测及调优/04"><span>24 | 如何优化JVM内存分配？</span></a></li><li><a href="/blog-test/java性能调优实战/05.模块四·jvm性能监测及调优/05"><span>25 | 内存持续上升，我该如何排查问题？</span></a></li><li><a href="/blog-test/java性能调优实战/05.模块四·jvm性能监测及调优/06"><span>26 | 答疑课堂：模块四热点问题解答</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/06.模块五·设计模式调优">06.模块五·设计模式调优</a><ul><li><a href="/blog-test/java性能调优实战/06.模块五·设计模式调优/01"><span>27 | 单例模式：如何创建单一对象优化系统性能？</span></a></li><li><a href="/blog-test/java性能调优实战/06.模块五·设计模式调优/02"><span>28 | 原型模式与享元模式：提升系统性能的利器</span></a></li><li><a href="/blog-test/java性能调优实战/06.模块五·设计模式调优/03"><span>29 | 如何使用设计模式优化并发编程？</span></a></li><li><a href="/blog-test/java性能调优实战/06.模块五·设计模式调优/04"><span>30 | 生产者消费者模式：电商库存设计优化</span></a></li><li><a href="/blog-test/java性能调优实战/06.模块五·设计模式调优/05"><span>31 | 装饰器模式：如何优化电商系统中复杂的商品价格策略？</span></a></li><li><a href="/blog-test/java性能调优实战/06.模块五·设计模式调优/06"><span>32 | 答疑课堂：模块五思考题集锦</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优">07.模块六·数据库性能调优</a><ul><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/01"><span>33 | MySQL调优之SQL语句：如何写出高性能SQL语句？</span></a></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/02"><span>34 | MySQL调优之事务：高并发场景下的数据库事务调优</span></a></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/03"><span>35 | MySQL调优之索引：索引的失效与优化</span></a></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/04"><span>36 | 记一次线上SQL死锁事故：如何避免死锁？</span></a></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/05"><span>37 | 什么时候需要分表分库？</span></a></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/06"><span>38 | 电商系统表设计优化案例分析</span></a></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/07"><span>39 | 数据库参数设置优化，失之毫厘差之千里</span></a></li><li><a href="/blog-test/java性能调优实战/07.模块六·数据库性能调优/08"><span>40 | 答疑课堂：MySQL中InnoDB的知识点串讲</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/08.模块七·实战演练场">08.模块七·实战演练场</a><ul><li><a href="/blog-test/java性能调优实战/08.模块七·实战演练场/01"><span>41 | 如何设计更优的分布式锁？</span></a></li><li><a href="/blog-test/java性能调优实战/08.模块七·实战演练场/02"><span>42 | 电商系统的分布式事务调优</span></a></li><li><a href="/blog-test/java性能调优实战/08.模块七·实战演练场/03"><span>43 | 如何使用缓存优化系统性能？</span></a></li><li><a href="/blog-test/java性能调优实战/08.模块七·实战演练场/04"><span>44 | 记一次双十一抢购性能瓶颈调优</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/09.结束语">09.结束语</a><ul><li><a href="/blog-test/java性能调优实战/09.结束语/01"><span>结束语 | 栉风沐雨，砥砺前行！</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/10.期末测试">10.期末测试</a><ul><li><a href="/blog-test/java性能调优实战/10.期末测试/01"><span>期末测试 | 有关Java性能调优，你掌握了多少呢？</span></a></li></ul></li><li><a href="/blog-test/java性能调优实战/summary">java性能调优实战</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="什么是乐观锁" data-depth="2"><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#什么是乐观锁"><span>什么是乐观锁</span></a></li><li title="乐观锁的实现原理" data-depth="2"><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#乐观锁的实现原理"><span>乐观锁的实现原理</span></a></li><li title="1.CAS如何实现原子操作" data-depth="3"><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#1cas如何实现原子操作"><span>1.CAS如何实现原子操作</span></a></li><li title="2.处理器如何实现原子操作" data-depth="3"><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#2处理器如何实现原子操作"><span>2.处理器如何实现原子操作</span></a></li><li title="优化CAS乐观锁" data-depth="2"><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#优化cas乐观锁"><span>优化CAS乐观锁</span></a></li><li title="总结" data-depth="2"><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#总结"><span>总结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="14--多线程之锁优化下使用乐观锁优化并行操作"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#14--多线程之锁优化下使用乐观锁优化并行操作"><span class="icon icon-link"></span></a>14 | 多线程之锁优化（下）：使用乐观锁优化并行操作</h1><p>你好，我是刘超。</p><p>前两讲我们讨论了Synchronized和Lock实现的同步锁机制，这两种同步锁都属于悲观锁，是保护线程安全最直观的方式。</p><p>我们知道悲观锁在高并发的场景下，激烈的锁竞争会造成线程阻塞，大量阻塞线程会导致系统的上下文切换，增加系统的性能开销。那有没有可能实现一种非阻塞型的锁机制来保证线程的安全呢？答案是肯定的。今天我就带你学习下乐观锁的优化方法，看看怎么使用才能发挥它最大的价值。</p><h2 id="什么是乐观锁"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#什么是乐观锁"><span class="icon icon-link"></span></a>什么是乐观锁</h2><p>开始优化前，我们先来简单回顾下乐观锁的定义。</p><p>乐观锁，顾名思义，就是说在操作共享资源时，它总是抱着乐观的态度进行，它认为自己可以成功地完成操作。但实际上，当多个线程同时操作一个共享资源时，只有一个线程会成功，那么失败的线程呢？它们不会像悲观锁一样在操作系统中挂起，而仅仅是返回，并且系统允许失败的线程重试，也允许自动放弃退出操作。</p><p>所以，乐观锁相比悲观锁来说，不会带来死锁、饥饿等活性故障问题，线程间的相互影响也远远比悲观锁要小。更为重要的是，乐观锁没有因竞争造成的系统开销，所以在性能上也是更胜一筹。</p><h2 id="乐观锁的实现原理"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#乐观锁的实现原理"><span class="icon icon-link"></span></a>乐观锁的实现原理</h2><p>相信你对上面的内容是有一定的了解的，下面我们来看看乐观锁的实现原理，有助于我们从根本上总结优化方法。</p><p>CAS是实现乐观锁的核心算法，它包含了3个参数：V（需要更新的变量）、E（预期值）和N（最新值）。</p><p>只有当需要更新的变量等于预期值时，需要更新的变量才会被设置为最新值，如果更新值和预期值不同，则说明已经有其它线程更新了需要更新的变量，此时当前线程不做操作，返回V的真实值。</p><h3 id="1cas如何实现原子操作"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#1cas如何实现原子操作"><span class="icon icon-link"></span></a>1.CAS如何实现原子操作</h3><p>在JDK中的concurrent包中，atomic路径下的类都是基于CAS实现的。AtomicInteger就是基于CAS实现的一个线程安全的整型类。下面我们通过源码来了解下如何使用CAS实现原子操作。</p><p>我们可以看到AtomicInteger的自增方法getAndIncrement是用了Unsafe的getAndAddInt方法，显然AtomicInteger依赖于本地方法Unsafe类，Unsafe类中的操作方法会调用CPU底层指令实现原子操作。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">//基于CAS操作更新值</span></div><div class="token-line"><span class="token plain">        public final boolean compareAndSet(int expect, int update) {</span></div><div class="token-line"><span class="token plain">            return unsafe.compareAndSwapInt(this, valueOffset, expect, update);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        //基于CAS操作增1</span></div><div class="token-line"><span class="token plain">        public final int getAndIncrement() {</span></div><div class="token-line"><span class="token plain">            return unsafe.getAndAddInt(this, valueOffset, 1);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        </span></div><div class="token-line"><span class="token plain">        //基于CAS操作减1</span></div><div class="token-line"><span class="token plain">        public final int getAndDecrement() {</span></div><div class="token-line"><span class="token plain">            return unsafe.getAndAddInt(this, valueOffset, -1);</span></div></pre></div><h3 id="2处理器如何实现原子操作"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#2处理器如何实现原子操作"><span class="icon icon-link"></span></a>2.处理器如何实现原子操作</h3><p>CAS是调用处理器底层指令来实现原子操作，那么处理器底层又是如何实现原子操作的呢？</p><p>处理器和物理内存之间的通信速度要远慢于处理器间的处理速度，所以处理器有自己的内部缓存。如下图所示，在执行操作时，频繁使用的内存数据会缓存在处理器的L1、L2和L3高速缓存中，以加快频繁读取的速度。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>一般情况下，一个单核处理器能自我保证基本的内存操作是原子性的，当一个线程读取一个字节时，所有进程和线程看到的字节都是同一个缓存里的字节，其它线程不能访问这个字节的内存地址。</p><p>但现在的服务器通常是多处理器，并且每个处理器都是多核的。每个处理器维护了一块字节的内存，每个内核维护了一块字节的缓存，这时候多线程并发就会存在缓存不一致的问题，从而导致数据不一致。</p><p>这个时候，处理器提供了<strong>总线锁定</strong>和<strong>缓存锁定</strong>两个机制来保证复杂内存操作的原子性。</p><p>当处理器要操作一个共享变量的时候，其在总线上会发出一个Lock信号，这时其它处理器就不能操作共享变量了，该处理器会独享此共享内存中的变量。但总线锁定在阻塞其它处理器获取该共享变量的操作请求时，也可能会导致大量阻塞，从而增加系统的性能开销。</p><p>于是，后来的处理器都提供了缓存锁定机制，也就说当某个处理器对缓存中的共享变量进行了操作，就会通知其它处理器放弃存储该共享资源或者重新读取该共享资源。目前最新的处理器都支持缓存锁定机制。</p><h2 id="优化cas乐观锁"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#优化cas乐观锁"><span class="icon icon-link"></span></a>优化CAS乐观锁</h2><p>虽然乐观锁在并发性能上要比悲观锁优越，但是在写大于读的操作场景下，CAS失败的可能性会增大，如果不放弃此次CAS操作，就需要循环做CAS重试，这无疑会长时间地占用CPU。</p><p>在Java7中，通过以下代码我们可以看到：AtomicInteger的getAndSet方法中使用了for循环不断重试CAS操作，如果长时间不成功，就会给CPU带来非常大的执行开销。到了Java8，for循环虽然被去掉了，但我们反编译Unsafe类时就可以发现该循环其实是被封装在了Unsafe类中，CPU的执行开销依然存在。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public final int getAndSet(int newValue) {</span></div><div class="token-line"><span class="token plain">            for (;;) {</span></div><div class="token-line"><span class="token plain">                int current = get();</span></div><div class="token-line"><span class="token plain">                if (compareAndSet(current, newValue))</span></div><div class="token-line"><span class="token plain">                    return current;</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        }</span></div></pre></div><p>在JDK1.8中，Java提供了一个新的原子类LongAdder。LongAdder在高并发场景下会比AtomicInteger和AtomicLong的性能更好，代价就是会消耗更多的内存空间。</p><p>LongAdder的原理就是降低操作共享变量的并发数，也就是将对单一共享变量的操作压力分散到多个变量值上，将竞争的每个写线程的value值分散到一个数组中，不同线程会命中到数组的不同槽中，各个线程只对自己槽中的value值进行CAS操作，最后在读取值的时候会将原子操作的共享变量与各个分散在数组的value值相加，返回一个近似准确的数值。</p><p>LongAdder内部由一个base变量和一个cell[]数组组成。当只有一个写线程，没有竞争的情况下，LongAdder会直接使用base变量作为原子操作变量，通过CAS操作修改变量；当有多个写线程竞争的情况下，除了占用base变量的一个写线程之外，其它各个线程会将修改的变量写入到自己的槽cell[]数组中，最终结果可通过以下公式计算得出：</p><p><img src="data:image/jpeg;base64,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" alt=""/></p><p>我们可以发现，LongAdder在操作后的返回值只是一个近似准确的数值，但是LongAdder最终返回的是一个准确的数值， 所以在一些对实时性要求比较高的场景下，LongAdder并不能取代AtomicInteger或AtomicLong。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#总结"><span class="icon icon-link"></span></a>总结</h2><p>在日常开发中，使用乐观锁最常见的场景就是数据库的更新操作了。为了保证操作数据库的原子性，我们常常会为每一条数据定义一个版本号，并在更新前获取到它，到了更新数据库的时候，还要判断下已经获取的版本号是否被更新过，如果没有，则执行该操作。</p><p>CAS乐观锁在平常使用时比较受限，它只能保证单个变量操作的原子性，当涉及到多个变量时，CAS就无能为力了，但前两讲讲到的悲观锁可以通过对整个代码块加锁来做到这点。</p><p>CAS乐观锁在高并发写大于读的场景下，大部分线程的原子操作会失败，失败后的线程将会不断重试CAS原子操作，这样就会导致大量线程长时间地占用CPU资源，给系统带来很大的性能开销。在JDK1.8中，Java新增了一个原子类LongAdder，它使用了空间换时间的方法，解决了上述问题。</p><p>11～13讲的内容，我详细地讲解了基于JVM实现的同步锁Synchronized，AQS实现的同步锁Lock以及CAS实现的乐观锁。相信你也很好奇，这三种锁，到底哪一种的性能最好，现在我们来对比下三种不同实现方式下的锁的性能。</p><p>鉴于脱离实际业务场景的性能对比测试没有意义，我们可以分别在“读多写少”“读少写多”“读写差不多”这三种场景下进行测试。又因为锁的性能还与竞争的激烈程度有关，所以除此之外，我们还将做三种锁在不同竞争级别下的性能测试。</p><p>综合上述条件，我将对四种模式下的五个锁Synchronized、ReentrantLock、ReentrantReadWriteLock、StampedLock以及乐观锁LongAdder进行压测。</p><p>这里简要说明一下：我是在不同竞争级别的情况下，用不同的读写线程数组合出了四组测试，测试代码使用了计算并发计数器，读线程会去读取计数器的值，而写线程会操作变更计数器值，运行环境是4核的i7处理器。结果已给出，具体的测试代码可以点击<a target="_blank" rel="noopener noreferrer" href="https://github.com/nickliuchao/lockTest">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>查看下载。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimaged51ed5906bf5be6a91cb4ab3e4511da2421e.4587eb87.jpg" alt=""/></p><p>通过以上结果，我们可以发现：在读大于写的场景下，读写锁ReentrantReadWriteLock、StampedLock以及乐观锁的读写性能是最好的；在写大于读的场景下，乐观锁的性能是最好的，其它4种锁的性能则相差不多；在读和写差不多的场景下，两种读写锁以及乐观锁的性能要优于Synchronized和ReentrantLock。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-test/java性能调优实战/04.模块三·多线程性能调优/03#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>我们在使用CAS操作的时候要注意的ABA问题指的是什么呢？</p><p>期待在留言区看到你的答案。也欢迎你点击“请朋友读”，把今天的内容分享给身边的朋友，邀请他一起学习。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/java性能调优实战/04.模块三·多线程性能调优/03.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 09:43:57</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-test/umi.3ded5539.js"></script>
  </body>
</html>
