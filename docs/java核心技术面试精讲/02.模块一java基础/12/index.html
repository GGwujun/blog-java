<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-test/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-test";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>第12讲 | Java有几种文件拷贝方式？哪一种最高效？ - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/java核心技术面试精讲/02.模块一java基础/12" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>java开发<ul><li><a href="/blog-test/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-test/java并发编程实战">java并发编程实战</a></li><li><a href="/blog-test/java性能调优实战">java性能调优实战</a></li><li><a aria-current="page" class="active" href="/blog-test/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-test/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-test/深入剖析java新特性">深入剖析java新特性</a></li><li><a href="/blog-test/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></span><span>架构师<ul><li><a href="/blog-test/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a href="/blog-test/从0开始学微服务">从0开始学微服务</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-test/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>java开发<ul><li><a href="/blog-test/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-test/java并发编程实战">java并发编程实战</a></li><li><a href="/blog-test/java性能调优实战">java性能调优实战</a></li><li><a aria-current="page" class="active" href="/blog-test/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-test/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-test/深入剖析java新特性">深入剖析java新特性</a></li><li><a href="/blog-test/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></li><li>架构师<ul><li><a href="/blog-test/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a href="/blog-test/从0开始学微服务">从0开始学微服务</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-test/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-test/java核心技术面试精讲/01.开篇词">01.开篇词</a><ul><li><a href="/blog-test/java核心技术面试精讲/01.开篇词/01"><span>开篇词 | 以面试题为切入点，有效提升你的Java内功</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-test/java核心技术面试精讲/02.模块一java基础">02.模块一Java基础</a><ul><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/01"><span>第1讲 | 谈谈你对Java平台的理解？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/02"><span>第2讲 | Exception和Error有什么区别？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/03"><span>第3讲 | 谈谈final、finally、 finalize有什么不同？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/04"><span>第4讲 | 强引用、软引用、弱引用、幻象引用有什么区别？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/05"><span>第5讲 | String、StringBuffer、StringBuilder有什么区别？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/06"><span>第6讲 | 动态代理是基于什么原理？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/07"><span>第7讲 | int和Integer有什么区别？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/08"><span>第8讲 | 对比Vector、ArrayList、LinkedList有何区别？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/09"><span>第9讲 | 对比Hashtable、HashMap、TreeMap有什么不同？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/10"><span>第10讲 | 如何保证集合是线程安全的? ConcurrentHashMap如何实现高效地线程安全？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/11"><span>第11讲 | Java提供了哪些IO方式？ NIO如何实现多路复用？</span></a></li><li><a aria-current="page" class="active" href="/blog-test/java核心技术面试精讲/02.模块一java基础/12"><span>第12讲 | Java有几种文件拷贝方式？哪一种最高效？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/13"><span>第13讲 | 谈谈接口和抽象类有什么区别？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/14"><span>第14讲 | 谈谈你知道的设计模式？</span></a></li></ul></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶">03.模块二Java进阶</a><ul><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/01"><span>第15讲 | synchronized和ReentrantLock有什么区别呢？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/02"><span>第16讲 | synchronized底层如何实现？什么是锁的升级、降级？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/03"><span>第17讲 | 一个线程两次调用start()方法会出现什么情况？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/04"><span>第18讲 | 什么情况下Java程序会产生死锁？如何定位、修复？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/05"><span>第19讲 | Java并发包提供了哪些并发工具类？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/06"><span>第20讲 | 并发包中的ConcurrentLinkedQueue和LinkedBlockingQueue有什么区别？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/07"><span>第21讲 | Java并发类库提供的线程池有哪几种？ 分别有什么特点？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/08"><span>第22讲 | AtomicInteger底层实现原理是什么？如何在自己的产品代码中应用CAS操作？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/09"><span>第23讲 | 请介绍类加载过程，什么是双亲委派模型？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/10"><span>第24讲 | 有哪些方法可以在运行时动态生成一个Java类？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/11"><span>第25讲 | 谈谈JVM内存区域的划分，哪些区域可能发生OutOfMemoryError?</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/12"><span>第26讲 | 如何监控和诊断JVM堆内和堆外内存使用？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/13"><span>第27讲 | Java常见的垃圾收集器有哪些？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/14"><span>第28讲 | 谈谈你的GC调优思路?</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/15"><span>第29讲 | Java内存模型中的happen-before是什么？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/03.模块二java进阶/16"><span>第30讲 | Java程序运行在Docker等容器环境有哪些新问题？</span></a></li></ul></li><li><a href="/blog-test/java核心技术面试精讲/04.模块三java安全基础">04.模块三Java安全基础</a><ul><li><a href="/blog-test/java核心技术面试精讲/04.模块三java安全基础/01"><span>第31讲 | 你了解Java应用开发中的注入攻击吗？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/04.模块三java安全基础/02"><span>第32讲 | 如何写出安全的Java代码？</span></a></li></ul></li><li><a href="/blog-test/java核心技术面试精讲/05.模块四java性能基础">05.模块四Java性能基础</a><ul><li><a href="/blog-test/java核心技术面试精讲/05.模块四java性能基础/01"><span>第33讲 | 后台服务出现明显“变慢”，谈谈你的诊断思路？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/05.模块四java性能基础/02"><span>第34讲 | 有人说“Lambda能让Java程序慢30倍”，你怎么看？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/05.模块四java性能基础/03"><span>第35讲 | JVM优化Java代码时都做了什么？</span></a></li></ul></li><li><a href="/blog-test/java核心技术面试精讲/06.模块5java应用开发扩展">06.模块5Java应用开发扩展</a><ul><li><a href="/blog-test/java核心技术面试精讲/06.模块5java应用开发扩展/01"><span>第36讲 | 谈谈MySQL支持的事务隔离级别，以及悲观锁和乐观锁的原理和应用场景？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/06.模块5java应用开发扩展/02"><span>第37讲 | 谈谈Spring Bean的生命周期和作用域？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/06.模块5java应用开发扩展/03"><span>第38讲 | 对比Java标准NIO类库，你知道Netty是如何实现更高性能的吗？</span></a></li><li><a href="/blog-test/java核心技术面试精讲/06.模块5java应用开发扩展/04"><span>第39讲 | 谈谈常用的分布式ID的设计方案？Snowflake是否受冬令时切换影响？</span></a></li></ul></li><li><a href="/blog-test/java核心技术面试精讲/07.周末福利">07.周末福利</a><ul><li><a href="/blog-test/java核心技术面试精讲/07.周末福利/01"><span>周末福利 | 谈谈我对Java学习和面试的看法</span></a></li><li><a href="/blog-test/java核心技术面试精讲/07.周末福利/02"><span>周末福利 | 一份Java工程师必读书单</span></a></li></ul></li><li><a href="/blog-test/java核心技术面试精讲/08.结束语">08.结束语</a><ul><li><a href="/blog-test/java核心技术面试精讲/08.结束语/01"><span>结束语 | 技术没有终点</span></a></li><li><a href="/blog-test/java核心技术面试精讲/08.结束语/02"><span>结课测试 | Java核心技术的这些知识，你真的掌握了吗？</span></a></li></ul></li><li><a href="/blog-test/java核心技术面试精讲/summary">java核心技术面试精讲</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="典型回答" data-depth="2"><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#典型回答"><span>典型回答</span></a></li><li title="考点分析" data-depth="2"><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#考点分析"><span>考点分析</span></a></li><li title="知识扩展" data-depth="2"><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#知识扩展"><span>知识扩展</span></a></li><li title="一课一练" data-depth="2"><a href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#一课一练"><span>一课一练</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="第12讲--java有几种文件拷贝方式哪一种最高效"><a aria-hidden="true" tabindex="-1" href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#第12讲--java有几种文件拷贝方式哪一种最高效"><span class="icon icon-link"></span></a>第12讲 | Java有几种文件拷贝方式？哪一种最高效？</h1><p>我在专栏上一讲提到，NIO不止是多路复用，NIO 2也不只是异步IO，今天我们来看看Java IO体系中，其他不可忽略的部分。</p><p>今天我要问你的问题是，Java有几种文件拷贝方式？哪一种最高效？</p><h2 id="典型回答"><a aria-hidden="true" tabindex="-1" href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#典型回答"><span class="icon icon-link"></span></a>典型回答</h2><p>Java有多种比较典型的文件拷贝实现方式，比如：</p><p>利用java.io类库，直接为源文件构建一个FileInputStream读取，然后再为目标文件构建一个FileOutputStream，完成写入工作。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static void copyFileByStream(File source, File dest) throws</span></div><div class="token-line"><span class="token plain">            IOException {</span></div><div class="token-line"><span class="token plain">        try (InputStream is = new FileInputStream(source);</span></div><div class="token-line"><span class="token plain">             OutputStream os = new FileOutputStream(dest);){</span></div><div class="token-line"><span class="token plain">            byte[] buffer = new byte[1024];</span></div><div class="token-line"><span class="token plain">            int length;</span></div><div class="token-line"><span class="token plain">            while ((length = is.read(buffer)) &gt; 0) {</span></div><div class="token-line"><span class="token plain">                os.write(buffer, 0, length);</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">     }</span></div></pre></div><p>或者，利用java.nio类库提供的transferTo或transferFrom方法实现。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static void copyFileByChannel(File source, File dest) throws</span></div><div class="token-line"><span class="token plain">            IOException {</span></div><div class="token-line"><span class="token plain">        try (FileChannel sourceChannel = new FileInputStream(source)</span></div><div class="token-line"><span class="token plain">                .getChannel();</span></div><div class="token-line"><span class="token plain">             FileChannel targetChannel = new FileOutputStream(dest).getChannel</span></div><div class="token-line"><span class="token plain">                     ();){</span></div><div class="token-line"><span class="token plain">            for (long count = sourceChannel.size() ;count&gt;0 ;) {</span></div><div class="token-line"><span class="token plain">                long transferred = sourceChannel.transferTo(</span></div><div class="token-line"><span class="token plain">                        sourceChannel.position(), count, targetChannel);            sourceChannel.position(sourceChannel.position() + transferred);</span></div><div class="token-line"><span class="token plain">                count -= transferred;</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">     }</span></div></pre></div><p>当然，Java标准类库本身已经提供了几种Files.copy的实现。</p><p>对于Copy的效率，这个其实与操作系统和配置等情况相关，总体上来说，NIO transferTo/From的方式<strong>可能更快</strong>，因为它更能利用现代操作系统底层机制，避免不必要拷贝和上下文切换。</p><h2 id="考点分析"><a aria-hidden="true" tabindex="-1" href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#考点分析"><span class="icon icon-link"></span></a>考点分析</h2><p>今天这个问题，从面试的角度来看，确实是一个面试考察的点，针对我上面的典型回答，面试官还可能会从实践角度，或者IO底层实现机制等方面进一步提问。这一讲的内容从面试题出发，主要还是为了让你进一步加深对Java IO类库设计和实现的了解。</p><p>从实践角度，我前面并没有明确说NIO transfer的方案一定最快，真实情况也确实未必如此。我们可以根据理论分析给出可行的推断，保持合理的怀疑，给出验证结论的思路，有时候面试官考察的就是如何将猜测变成可验证的结论，思考方式远比记住结论重要。</p><p>从技术角度展开，下面这些方面值得注意：</p><ul><li><p>不同的copy方式，底层机制有什么区别？</p></li><li><p>为什么零拷贝（zero-copy）可能有性能优势？</p></li><li><p>Buffer分类与使用。</p></li><li><p>Direct Buffer对垃圾收集等方面的影响与实践选择。</p></li></ul><p>接下来，我们一起来分析一下吧。</p><h2 id="知识扩展"><a aria-hidden="true" tabindex="-1" href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#知识扩展"><span class="icon icon-link"></span></a>知识扩展</h2><p>1.拷贝实现机制分析</p><p>先来理解一下，前面实现的不同拷贝方法，本质上有什么明显的区别。</p><p>首先，你需要理解用户态空间（User Space）和内核态空间（Kernel Space），这是操作系统层面的基本概念，操作系统内核、硬件驱动等运行在内核态空间，具有相对高的特权；而用户态空间，则是给普通应用和服务使用。你可以参考：<a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/User_space">https://en.wikipedia.org/wiki/User_space<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>当我们使用输入输出流进行读写时，实际上是进行了多次上下文切换，比如应用读取数据时，先在内核态将数据从磁盘读取到内核缓存，再切换到用户态将数据从内核缓存读取到用户缓存。</p><p>写入操作也是类似，仅仅是步骤相反，你可以参考下面这张图。</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimage6d856d2368424431f1b0d2b935386324b585.f3daf070.png" alt=""/></p><p>所以，这种方式会带来一定的额外开销，可能会降低IO效率。</p><p>而基于NIO transferTo的实现方式，在Linux和Unix上，则会使用到零拷贝技术，数据传输并不需要用户态参与，省去了上下文切换的开销和不必要的内存拷贝，进而可能提高应用拷贝性能。注意，transferTo不仅仅是可以用在文件拷贝中，与其类似的，例如读取磁盘文件，然后进行Socket发送，同样可以享受这种机制带来的性能和扩展性提高。</p><p>transferTo的传输过程是：</p><p><img src="/blog-test/static/httpsstatic001geekbangorgresourceimageb0eab0c8226992bb97adda5ad84fe25372ea.fac16c92.png" alt=""/></p><p>2.Java IO/NIO源码结构</p><p>前面我在典型回答中提了第三种方式，即Java标准库也提供了文件拷贝方法（java.nio.file.Files.copy）。如果你这样回答，就一定要小心了，因为很少有问题的答案是仅仅调用某个方法。从面试的角度，面试官往往会追问：既然你提到了标准库，那么它是怎么实现的呢？有的公司面试官以喜欢追问而出名，直到追问到你说不知道。</p><p>其实，这个问题的答案还真不是那么直观，因为实际上有几个不同的copy方法。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static Path copy(Path source, Path target, CopyOption... options)</span></div><div class="token-line"><span class="token plain">        throws IOException</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static long copy(InputStream in, Path target, CopyOption... options)</span></div><div class="token-line"><span class="token plain">        throws IOException</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static long copy(Path source, OutputStream out) </span></div><div class="token-line"><span class="token plain">    throws IOException</span></div></pre></div><p>可以看到，copy不仅仅是支持文件之间操作，没有人限定输入输出流一定是针对文件的，这是两个很实用的工具方法。</p><p>后面两种copy实现，能够在方法实现里直接看到使用的是InputStream.transferTo()，你可以直接看源码，其内部实现其实是stream在用户态的读写；而对于第一种方法的分析过程要相对麻烦一些，可以参考下面片段。简单起见，我只分析同类型文件系统拷贝过程。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public static Path copy(Path source, Path target, CopyOption... options)</span></div><div class="token-line"><span class="token plain">        throws IOException</span></div><div class="token-line"><span class="token plain">     {</span></div><div class="token-line"><span class="token plain">        FileSystemProvider provider = provider(source);</span></div><div class="token-line"><span class="token plain">        if (provider(target) == provider) {</span></div><div class="token-line"><span class="token plain">            // same provider</span></div><div class="token-line"><span class="token plain">            provider.copy(source, target, options);//这是本文分析的路径</span></div><div class="token-line"><span class="token plain">        } else {</span></div><div class="token-line"><span class="token plain">            // different providers</span></div><div class="token-line"><span class="token plain">            CopyMoveHelper.copyToForeignTarget(source, target, options);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        return target;</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>我把源码分析过程简单记录如下，JDK的源代码中，内部实现和公共API定义也不是可以能够简单关联上的，NIO部分代码甚至是定义为模板而不是Java源文件，在build过程自动生成源码，下面顺便介绍一下部分JDK代码机制和如何绕过隐藏障碍。</p><ul><li><p>首先，直接跟踪，发现FileSystemProvider只是个抽象类，阅读它的<a target="_blank" rel="noopener noreferrer" href="http://hg.openjdk.java.net/jdk/jdk/file/f84ae8aa5d88/src/java.base/share/classes/java/nio/file/spi/FileSystemProvider.java">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>能够理解到，原来文件系统实际逻辑存在于JDK内部实现里，公共API其实是通过ServiceLoader机制加载一系列文件系统实现，然后提供服务。</p></li><li><p>我们可以在JDK源码里搜索FileSystemProvider和nio，可以定位到<a target="_blank" rel="noopener noreferrer" href="http://hg.openjdk.java.net/jdk/jdk/file/f84ae8aa5d88/src/java.base/share/classes/sun/nio/fs">sun/nio/fs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，我们知道NIO底层是和操作系统紧密相关的，所以每个平台都有自己的部分特有文件系统逻辑。</p></li></ul><p><img src="data:image/png;base64,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" alt=""/></p><ul><li><p>省略掉一些细节，最后我们一步步定位到UnixFileSystemProvider → UnixCopyFile.Transfer，发现这是个本地方法。</p></li><li><p>最后，明确定位到<a target="_blank" rel="noopener noreferrer" href="http://hg.openjdk.java.net/jdk/jdk/file/f84ae8aa5d88/src/java.base/unix/native/libnio/fs/UnixCopyFile.c">UnixCopyFile.c<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，其内部实现清楚说明竟然只是简单的用户态空间拷贝！</p></li></ul><p>所以，我们明确这个最常见的copy方法其实不是利用transferTo，而是本地技术实现的用户态拷贝。</p><p>前面谈了不少机制和源码，我简单从实践角度总结一下，如何提高类似拷贝等IO操作的性能，有一些宽泛的原则：</p><ul><li><p>在程序中，使用缓存等机制，合理减少IO次数（在网络通信中，如TCP传输，window大小也可以看作是类似思路）。</p></li><li><p>使用transferTo等机制，减少上下文切换和额外IO操作。</p></li><li><p>尽量减少不必要的转换过程，比如编解码；对象序列化和反序列化，比如操作文本文件或者网络通信，如果不是过程中需要使用文本信息，可以考虑不要将二进制信息转换成字符串，直接传输二进制信息。</p></li></ul><p>3.掌握NIO Buffer</p><p>我在上一讲提到Buffer是NIO操作数据的基本工具，Java为每种原始数据类型都提供了相应的Buffer实现（布尔除外），所以掌握和使用Buffer是十分必要的，尤其是涉及Direct Buffer等使用，因为其在垃圾收集等方面的特殊性，更要重点掌握。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>Buffer有几个基本属性：</p><ul><li><p>capacity，它反映这个Buffer到底有多大，也就是数组的长度。</p></li><li><p>position，要操作的数据起始位置。</p></li><li><p>limit，相当于操作的限额。在读取或者写入时，limit的意义很明显是不一样的。比如，读取操作时，很可能将limit设置到所容纳数据的上限；而在写入时，则会设置容量或容量以下的可写限度。</p></li><li><p>mark，记录上一次postion的位置，默认是0，算是一个便利性的考虑，往往不是必须的。</p></li></ul><p>前面三个是我们日常使用最频繁的，我简单梳理下Buffer的基本操作：</p><ul><li><p>我们创建了一个ByteBuffer，准备放入数据，capacity当然就是缓冲区大小，而position就是0，limit默认就是capacity的大小。</p></li><li><p>当我们写入几个字节的数据时，position就会跟着水涨船高，但是它不可能超过limit的大小。</p></li><li><p>如果我们想把前面写入的数据读出来，需要调用flip方法，将position设置为0，limit设置为以前的position那里。</p></li><li><p>如果还想从头再读一遍，可以调用rewind，让limit不变，position再次设置为0。</p></li></ul><p>更进一步的详细使用，我建议参考相关<a target="_blank" rel="noopener noreferrer" href="http://tutorials.jenkov.com/java-nio/buffers.html">教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>4.Direct Buffer和垃圾收集</p><p>我这里重点介绍两种特别的Buffer。</p><ul><li><p>Direct Buffer：如果我们看Buffer的方法定义，你会发现它定义了isDirect()方法，返回当前Buffer是否是Direct类型。这是因为Java提供了堆内和堆外（Direct）Buffer，我们可以以它的allocate或者allocateDirect方法直接创建。</p></li><li><p>MappedByteBuffer：它将文件按照指定大小直接映射为内存区域，当程序访问这个内存区域时将直接操作这块儿文件数据，省去了将数据从内核空间向用户空间传输的损耗。我们可以使用<a target="_blank" rel="noopener noreferrer" href="https://docs.oracle.com/javase/9/docs/api/java/nio/channels/FileChannel.html#map-java.nio.channels.FileChannel.MapMode-long-long-">FileChannel.map<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>创建MappedByteBuffer，它本质上也是种Direct Buffer。</p></li></ul><p>在实际使用中，Java会尽量对Direct Buffer仅做本地IO操作，对于很多大数据量的IO密集操作，可能会带来非常大的性能优势，因为：</p><ul><li><p>Direct Buffer生命周期内内存地址都不会再发生更改，进而内核可以安全地对其进行访问，很多IO操作会很高效。</p></li><li><p>减少了堆内对象存储的可能额外维护工作，所以访问效率可能有所提高。</p></li></ul><p>但是请注意，Direct Buffer创建和销毁过程中，都会比一般的堆内Buffer增加部分开销，所以通常都建议用于长期使用、数据较大的场景。</p><p>使用Direct Buffer，我们需要清楚它对内存和JVM参数的影响。首先，因为它不在堆上，所以Xmx之类参数，其实并不能影响Direct Buffer等堆外成员所使用的内存额度，我们可以使用下面参数设置大小：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">-XX:MaxDirectMemorySize=512M</span></div></pre></div><p>从参数设置和内存问题排查角度来看，这意味着我们在计算Java可以使用的内存大小的时候，不能只考虑堆的需要，还有Direct Buffer等一系列堆外因素。如果出现内存不足，堆外内存占用也是一种可能性。</p><p>另外，大多数垃圾收集过程中，都不会主动收集Direct Buffer，它的垃圾收集过程，就是基于我在专栏前面所介绍的Cleaner（一个内部实现）和幻象引用（PhantomReference）机制，其本身不是public类型，内部实现了一个Deallocator负责销毁的逻辑。对它的销毁往往要拖到full GC的时候，所以使用不当很容易导致OutOfMemoryError。</p><p>对于Direct Buffer的回收，我有几个建议：</p><ul><li><p>在应用程序中，显式地调用System.gc()来强制触发。</p></li><li><p>另外一种思路是，在大量使用Direct Buffer的部分框架中，框架会自己在程序中调用释放方法，Netty就是这么做的，有兴趣可以参考其实现（PlatformDependent0）。</p></li><li><p>重复使用Direct Buffer。</p></li></ul><p>5.跟踪和诊断Direct Buffer内存占用？</p><p>因为通常的垃圾收集日志等记录，并不包含Direct Buffer等信息，所以Direct Buffer内存诊断也是个比较头疼的事情。幸好，在JDK 8之后的版本，我们可以方便地使用Native Memory Tracking（NMT）特性来进行诊断，你可以在程序启动时加上下面参数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">-XX:NativeMemoryTracking={summary|detail}</span></div></pre></div><p>注意，激活NMT通常都会导致JVM出现5%~10%的性能下降，请谨慎考虑。</p><p>运行时，可以采用下面命令进行交互式对比：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 打印NMT信息</span></div><div class="token-line"><span class="token plain">    jcmd &lt;pid&gt; VM.native_memory detail </span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 进行baseline，以对比分配内存变化</span></div><div class="token-line"><span class="token plain">    jcmd &lt;pid&gt; VM.native_memory baseline</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 进行baseline，以对比分配内存变化</span></div><div class="token-line"><span class="token plain">    jcmd &lt;pid&gt; VM.native_memory detail.diff</span></div></pre></div><p>我们可以在Internal部分发现Direct Buffer内存使用的信息，这是因为其底层实际是利用unsafe_allocatememory。严格说，这不是JVM内部使用的内存，所以在JDK 11以后，其实它是归类在other部分里。</p><p>JDK 9的输出片段如下，“+”表示的就是diff命令发现的分配变化：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">-Internal (reserved=679KB +4KB, committed=679KB +4KB)</span></div><div class="token-line"><span class="token plain">                  (malloc=615KB +4KB #1571 +4)</span></div><div class="token-line"><span class="token plain">                  (mmap: reserved=64KB, committed=64KB)</span></div></pre></div><p><strong>注意</strong>：JVM的堆外内存远不止Direct Buffer，NMT输出的信息当然也远不止这些，我在专栏后面有综合分析更加具体的内存结构的主题。</p><p>今天我分析了Java IO/NIO底层文件操作数据的机制，以及如何实现零拷贝的高性能操作，梳理了Buffer的使用和类型，并针对Direct Buffer的生命周期管理和诊断进行了较详细的分析。</p><h2 id="一课一练"><a aria-hidden="true" tabindex="-1" href="/blog-test/java核心技术面试精讲/02.模块一java基础/12#一课一练"><span class="icon icon-link"></span></a>一课一练</h2><p>关于今天我们讨论的题目你做到心中有数了吗？你可以思考下，如果我们需要在channel读取的过程中，将不同片段写入到相应的Buffer里面（类似二进制消息分拆成消息头、消息体等），可以采用NIO的什么机制做到呢？</p><p>请你在留言区写写你对这个问题的思考，我会选出经过认真思考的留言，送给你一份学习鼓励金，欢迎你与我一起讨论。</p><p>你的朋友是不是也在准备面试呢？你可以“请朋友读”，把今天的题目分享给好友，或许你能帮到他。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/java核心技术面试精讲/02.模块一Java基础/12.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 09:43:57</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-test/umi.3ded5539.js"></script>
  </body>
</html>
