<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-java/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-java";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>微博技术解密（下）| 微博存储的那些事儿 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/从0开始学微服务/06.阿忠伯的特别放送/04" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-java/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>java开发<ul><li><a href="/blog-java/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-java/java并发编程实战">java并发编程实战</a></li><li><a href="/blog-java/java性能调优实战">java性能调优实战</a></li><li><a href="/blog-java/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-java/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-java/深入剖析java新特性">深入剖析java新特性</a></li><li><a href="/blog-java/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></span><span>架构师<ul><li><a href="/blog-java/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a aria-current="page" class="active" href="/blog-java/从0开始学微服务">从0开始学微服务</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-java/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>java开发<ul><li><a href="/blog-java/java业务开发常见错误100例">java业务开发常见错误100例</a></li><li><a href="/blog-java/java并发编程实战">java并发编程实战</a></li><li><a href="/blog-java/java性能调优实战">java性能调优实战</a></li><li><a href="/blog-java/java核心技术面试精讲">java核心技术面试精讲</a></li><li><a href="/blog-java/spring编程常见错误50例">spring编程常见错误50例</a></li><li><a href="/blog-java/深入剖析java新特性">深入剖析java新特性</a></li><li><a href="/blog-java/深入拆解java虚拟机">深入拆解java虚拟机</a></li></ul></li><li>架构师<ul><li><a href="/blog-java/rpc实战与核心原理">rpc实战与核心原理</a></li><li><a aria-current="page" class="active" href="/blog-java/从0开始学微服务">从0开始学微服务</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-java/从0开始学微服务">从0开始学微服务</a></li><li><a href="/blog-java/从0开始学微服务/01.开篇词">01.开篇词</a><ul><li><a href="/blog-java/从0开始学微服务/01.开篇词/01"><span>开篇词 | 微服务，从放弃到入门</span></a></li></ul></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务">02.模块一入门微服务</a><ul><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/01"><span>01 | 到底什么是微服务？</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/02"><span>02 | 从单体应用走向服务化</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/03"><span>03 | 初探微服务架构</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/04"><span>04 | 如何发布和引用服务？</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/05"><span>05 | 如何注册和发现服务？</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/06"><span>06 | 如何实现RPC远程服务调用？</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/07"><span>07 | 如何监控微服务调用？</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/08"><span>08 | 如何追踪微服务调用？</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/09"><span>09 | 微服务治理的手段有哪些？</span></a></li><li><a href="/blog-java/从0开始学微服务/02.模块一入门微服务/10"><span>10 | Dubbo框架里的微服务组件</span></a></li></ul></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务">03.模块二落地微服务</a><ul><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/01"><span>11 | 服务发布和引用的实践</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/02"><span>12 | 如何将注册中心落地？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/03"><span>13 | 开源服务注册中心如何选型？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/04"><span>14 | 开源RPC框架如何选型？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/05"><span>15 | 如何搭建一个可靠的监控系统？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/06"><span>16 | 如何搭建一套适合你的服务追踪系统？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/07"><span>17 | 如何识别服务节点是否存活？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/08"><span>18 | 如何使用负载均衡算法？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/09"><span>19 | 如何使用服务路由？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/10"><span>20 | 服务端出现故障时该如何应对？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/11"><span>21 | 服务调用失败时有哪些处理手段？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/12"><span>22 | 如何管理服务配置？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/13"><span>23 | 如何搭建微服务治理平台？</span></a></li><li><a href="/blog-java/从0开始学微服务/03.模块二落地微服务/14"><span>24 | 微服务架构该如何落地？</span></a></li></ul></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务">04.模块三进阶微服务</a><ul><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/01"><span>25 | 微服务为什么要容器化？</span></a></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/02"><span>26 | 微服务容器化运维：镜像仓库和资源调度</span></a></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/03"><span>27 | 微服务容器化运维：容器调度和服务编排</span></a></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/04"><span>28 | 微服务容器化运维：微博容器运维平台DCP</span></a></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/05"><span>29 | 微服务如何实现DevOps？</span></a></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/06"><span>30 | 如何做好微服务容量规划？</span></a></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/07"><span>31 | 微服务多机房部署实践</span></a></li><li><a href="/blog-java/从0开始学微服务/04.模块三进阶微服务/08"><span>32 | 微服务混合云部署实践</span></a></li></ul></li><li><a href="/blog-java/从0开始学微服务/05.模块四展望微服务">05.模块四展望微服务</a><ul><li><a href="/blog-java/从0开始学微服务/05.模块四展望微服务/01"><span>33 | 下一代微服务架构Service Mesh</span></a></li><li><a href="/blog-java/从0开始学微服务/05.模块四展望微服务/02"><span>34 | Istio：Service Mesh的代表产品</span></a></li><li><a href="/blog-java/从0开始学微服务/05.模块四展望微服务/03"><span>35 | 微博Service Mesh实践之路（上）</span></a></li><li><a href="/blog-java/从0开始学微服务/05.模块四展望微服务/04"><span>36 | 微博Service Mesh实践之路（下）</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送">06.阿忠伯的特别放送</a><ul><li><a href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/01"><span>阿忠伯的特别放送 | 答疑解惑01</span></a></li><li><a href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/02"><span>阿忠伯的特别放送 | 答疑解惑02</span></a></li><li><a href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/03"><span>微博技术解密（上） | 微博信息流是如何实现的？</span></a></li><li><a aria-current="page" class="active" href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04"><span>微博技术解密（下）| 微博存储的那些事儿</span></a></li></ul></li><li><a href="/blog-java/从0开始学微服务/07.结束语">07.结束语</a><ul><li><a href="/blog-java/从0开始学微服务/07.结束语/01"><span>结束语 | 微服务，从入门到精通</span></a></li></ul></li><li><a href="/blog-java/从0开始学微服务/08.结课测试">08.结课测试</a><ul><li><a href="/blog-java/从0开始学微服务/08.结课测试/01"><span>结课测试｜这些微服务知识你都掌握了吗？</span></a></li></ul></li><li><a href="/blog-java/从0开始学微服务/summary">从0开始学微服务</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="MySQL" data-depth="2"><a href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#mysql"><span>MySQL</span></a></li><li title="Memcached" data-depth="2"><a href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#memcached"><span>Memcached</span></a></li><li title="Redis" data-depth="2"><a href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#redis"><span>Redis</span></a></li><li title="总结" data-depth="2"><a href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#总结"><span>总结</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="微博技术解密下-微博存储的那些事儿"><a aria-hidden="true" tabindex="-1" href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#微博技术解密下-微博存储的那些事儿"><span class="icon icon-link"></span></a>微博技术解密（下）| 微博存储的那些事儿</h1><p>今天是微博技术解密系列的第二期，我们来聊聊微博存储的使用经验。上一期“微博技术解密”我讲到微博主要使用了两大类存储：一类是数据库，主要以MySQL为主；一类是缓存，主要以Memcached和Redis为主。</p><p>今天我来分享一下微博在使用数据库和缓存方面的经验，也欢迎你给我留言一起切磋讨论。</p><h2 id="mysql"><a aria-hidden="true" tabindex="-1" href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#mysql"><span class="icon icon-link"></span></a>MySQL</h2><p>上一期我讲到微博Feed的存储使用了两层的结构，为了减少对MySQL数据库的访问压力，在前面部署了Memcached缓存，挡住了99%的访问压力，只有1%的请求会访问数据库。然而对于微博业务来说，这1%的请求也有几万QPS，对于单机只能扛几千QPS的MySQL数据库来说还是太大了。为此我们又对数据库端口进行了拆分，你可以看下面的示意图，每个用户的UID是唯一的，不同UID的用户按照一定的Hash规则访问不同的端口，这样的话单个数据库端口的访问量就会变成原来的1/8。除此之外，考虑到微博的读请求量要远大于写请求量，所以有必要对数据库的读写请求进行分离，写请求访问Master，读请求访问Slave，这样的话Master只需要一套，Slave根据访问量的需要可以有多套，也就是“一主多从”的架构。最后考虑到灾备的需要，还会在异地部署一套冷备的灾备数据库，平时不对外提供线上服务，每天对所有最新的数据进行备份，以防线上数据库发生同时宕机的情况。</p><p><img src="/blog-java/static/httpsstatic001geekbangorgresourceimageacb3ac361340ab002db47cafaa596c4293b3.f47630a3.png" alt=""/></p><h2 id="memcached"><a aria-hidden="true" tabindex="-1" href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#memcached"><span class="icon icon-link"></span></a>Memcached</h2><p>在MySQL数据库前面，还使用了Memcached作为缓存来承担几百万QPS的数据请求，产生的带宽问题是最大挑战。为此微博采用了下图所示的多层缓存结构，即L1-Master-Slave，它们的作用各不相同。</p><p>L1主要起到分担缓存带宽压力的作用，并且如果有需要可以无限进行横向扩展，任何一次数据请求，都随机请求其中一组L1缓存，这样的话，假如一共10组L1，数据请求量是200万QPS，那么每一组L1缓存的请求量就是1/10，也就是20万QPS；同时每一组缓存又包含了4台机器，按照用户UID进行Hash，每一台机器只存储其中一部分数据，这样的话每一台机器的访问量就只有1/4了。</p><p>Master主要起到防止访问穿透到数据库的作用，所以一般内存大小要比L1大得多，以存储尽可能多的数据。当L1缓存没有命中时，不能直接穿透到数据库，而是先访问Master。</p><p>Slave主要起到高可用的目的，以防止Master的缓存宕机时，从L1穿透访问的数据直接请求数据库，起到“兜底”的作用。</p><p><img src="/blog-java/static/httpsstatic001geekbangorgresourceimagefc2dfc8a927caf6d2991b0a2562863441f2d.7e3eb656.png" alt=""/></p><h2 id="redis"><a aria-hidden="true" tabindex="-1" href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#redis"><span class="icon icon-link"></span></a>Redis</h2><p>微博的存储除了大量使用MySQL和Memcached以外，还有一种存储也被广泛使用，那就是Redis。并且基于微博自身的业务特点，我们对原生的Redis进行了改造，因此诞生了两类主要的Redis存储组件：CounterService和Phantom。</p><p><strong>1. CounterService</strong></p><p>CounterService的主要应用场景就是计数器，比如微博的转发、评论、赞的计数。早期微博曾采用了Redis来存储微博的转发、评论、赞计数，但随着微博的数据量越来越大，发现Redis内存的有效负荷还是比较低的，它一条KV大概需要至少65个字节，但实际上一条微博的计数Key需要8个字节，Value大概4个字节，实际上有效的只有12个字节，其余四十多个字节都是被浪费的。这还只是单个KV，如果一条微博有多个计数的情况下，它的浪费就更多了，比如转评赞三个计数，一个Key是long结构，占用8个字节，每个计数是int结构，占用4个字节，三个计数大概需要20个字节就够了；而使用Redis的话，需要将近200个字节。正因为如此，我们研发了CounterService，相比Redis来说它的内存使用量减少到原来的1/15～1/5。而且还进行了冷热数据分离，热数据放到内存里，冷数据放到磁盘上，并使用LRU，如果冷数据重新变热，就重新放到内存中。</p><p>你可以看下面的示意图，CounterService的存储结构上面是内存下面是SSD，预先把内存分成N个Table，每个Table根据微博ID的指针序列，划出一定范围。任何一个微博ID过来先找到它所在的Table，如果有的话，直接对它进行增减；如果没有，就新增加一个Key。有新的微博ID过来，发现内存不够的时候，就会把最小的Table dump到SSD里面去，留着新的位置放在最上面供新的微博ID来使用。如果某一条微博特别热，转发、评论或者赞计数超过了4个字节，计数变得很大该怎么处理呢？对于超过限制的，我们把它放在Aux Dict进行存放，对于落在SSD里面的Table，我们有专门的Index进行访问，通过RDB方式进行复制。</p><p><img src="/blog-java/static/httpsstatic001geekbangorgresourceimage5a7b5ac693490234b05eb37cec6841a3097b.b38d2795.png" alt=""/></p><p><strong>2. Phantom</strong></p><p>微博还有一种场景是“存在性判断”，比如某一条微博某个用户是否赞过、某一条微博某个用户是否看过之类的。这种场景有个很大的特点，它检查是否存在，因此每条记录非常小，比如Value用1个位存储就够了，但总数据量又非常巨大。比如每天新发布的微博数量在1亿条左右，是否被用户读过的总数据量可能有上千亿，怎么存储是个非常大的挑战。而且还有一个特点是，大多数微博是否被用户读过的存在性都是0，如果存储0的话，每天就得存上千亿的记录；如果不存的话，就会有大量的请求最终会穿透Cache层到DB层，任何DB都没有办法抗住那么大的流量。</p><p>假设每天要存储上千亿条记录，用原生的Redis存储显然是不可行的，因为原生的Redis，单个KV就占了65个字节，这样每天存储上千亿条记录，需要增加将近6TB存储，显然是不可接受的。而用上面提到的微博自研的CounterService来存储的话，一个Key占8个字节，Value用1个位存储就够了，一个KV就占大约8个字节，这样每天存储上千亿条记录，需要增加将近800GB存储。虽然相比于原生的Redis存储方案，已经节省了很多，但存储成本依然很高，每天将近1TB。</p><p>所以就迫切需要一种更加精密的存储方案，针对存在性判断的场景能够最大限度优化存储空间，后来我们就自研了Phantom。</p><p>就像下图所描述的那样，Phantom跟CounterService一样，采取了分Table的存储方案，不同的是CounterService中每个Table存储的是KV，而Phantom的每个Table是一个完整的BloomFilter，每个BloomFilter存储的某个ID范围段的Key，所有Table形成一个列表并按照Key范围有序递增。当所有Table都存满的时候，就把最小的Table数据清除，存储最新的Key，这样的话最小的Table就滚动成为最大的Table了。</p><p><img src="/blog-java/static/httpsstatic001geekbangorgresourceimage5c1c5caa16bfda4b80f635276501b257871c.aaafb2c0.png" alt=""/></p><p>下图描述了Phantom的请求处理过程，当一个Key的读写请求过来时，先根据Key的范围确定这个Key属于哪个Table，然后再根据BloomFilter的算法判断这个Key是否存在。</p><p><img src="/blog-java/static/httpsstatic001geekbangorgresourceimage3dd43dd0fc260df19565c223f981564a1cd4.2cc32b17.png" alt=""/></p><p>这里我简单介绍一下BloomFilter是如何判断一个Key是否存在的，感兴趣的同学可以自己搜索一下BloomFilter算法的详细说明。为了判断某个Key是否存在，BloomFilter通过三次Hash函数到Table的不同位置，然后判断这三个位置的值是否为1，如果都是1则证明Key存在。</p><p>来看下面这张图，假设x1和x2存在，就把x1和x2通过Hash后找到的三个位置都设置成1。</p><p><img src="/blog-java/static/httpsstatic001geekbangorgresourceimage0180018815b6621a6e55fb5a69e0764f1180.77d0f2ed.png" alt=""/></p><p>再看下面这张图，判断y1和y2是否存在，就看y1和y2通过Hash后找到的三个位置是否都是1。比如图中y1第二个位置是0，说明y1不存在；而y2的三个位置都是1，说明y2存在。</p><p><img src="data:image/png;base64,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" alt=""/></p><p>Phantom正是通过把内存分成N个Table，每一个Table内使用BloomFilter判断是否存在，最终每天使用的内存只有120GB。而存在性判断的业务场景最高需要满足一周的需求，所以最多使用的内存也就是840GB。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-java/从0开始学微服务/06.阿忠伯的特别放送/04#总结"><span class="icon icon-link"></span></a>总结</h2><p>今天我给你讲解了微博业务中使用范围最广的三个存储组件：一个是MySQL，主要用作持久化存储数据，由于微博数据访问量大，所以进行了数据库端口的拆分来降低单个数据库端口的请求压力，并且进行了读写分离和异地灾备，采用了Master-Slave-Backup的架构；一个是Memcached，主要用作数据库前的缓存，减少对数据库访问的穿透并提高访问性能，采用了L1-Master-Slave的架构；一个是Redis，基于微博自身业务需要，我们对Redis进行了改造，自研了CounterService和Phantom，分别用于存储微博计数和存在性判断，大大减少了对内存的使用，节省了大量机器成本。</p><p>专栏更新到这里就要跟同学们说再见了，感谢你们在过去大半年时间里的陪伴，值此新春到来之际，老胡给您拜年啦，恭祝各位同学在新的一年里，工作顺顺利利，生活开开心心！</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/从0开始学微服务/06.阿忠伯的特别放送/04.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/27 11:06:36</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-java/umi.fde43fdb.js"></script>
  </body>
</html>
